use ogmocedesenv;

--matricula, mes, assiduicade(sum(1)/sum(*))
BEGIN 
	DECLARE @P_MES INT, @P_ANO INT;
	SET @P_ANO = 2015;
	SET @P_MES = 10;

	SELECT 
		A.MATRICULA,
		(SELECT COUNT(*) FROM ASSIDUIDADE A1 
			WHERE A1.MATRICULA = A.MATRICULA AND MONTH(DATA) = @P_MES AND YEAR(DATA)=@P_ANO) AS TOTAL,
		(SELECT COUNT(*) FROM ASSIDUIDADE A1 
			WHERE A1.SITUACAO = 1 AND A1.MATRICULA = A.MATRICULA AND MONTH(DATA) = @P_MES AND YEAR(DATA)=@P_ANO) AS SIM,
		(SELECT COUNT(*) FROM ASSIDUIDADE A1 
			WHERE A1.SITUACAO <> 1 AND A1.MATRICULA = A.MATRICULA AND MONTH(DATA) = @P_MES AND YEAR(DATA)=@P_ANO) AS NAO
	FROM ASSIDUIDADE A
	GROUP BY A.MATRICULA
	ORDER BY A.MATRICULA;
	
	
	SELECT * FROM ASSIDUIDADE WHERE MONTH(DATA) = 10 AND YEAR(DATA)=2015
END;



COMMIT
SELECT * FROM [LOG] WHERE TABELA = 'SP_CRIAR_ASSIDUIDADE'